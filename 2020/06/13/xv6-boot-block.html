<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>xv6 image: How exactly is the boot sector created and loaded? | yohei.codes</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="xv6 image: How exactly is the boot sector created and loaded?" />
<meta property="og:locale" content="en" />
<meta name="description" content="xv6 image: How exactly is the boot sector created and loaded?" />
<meta property="og:description" content="xv6 image: How exactly is the boot sector created and loaded?" />
<link rel="canonical" href="https://yohei.codes/2020/06/13/xv6-boot-block.html" />
<meta property="og:url" content="https://yohei.codes/2020/06/13/xv6-boot-block.html" />
<meta property="og:site_name" content="yohei.codes" />
<meta property="og:image" content="https://yohei.codes/assets/images/dax86-xv6.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-13T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://yohei.codes/assets/images/dax86-xv6.png" />
<meta property="twitter:title" content="xv6 image: How exactly is the boot sector created and loaded?" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-06-13T00:00:00+00:00","datePublished":"2020-06-13T00:00:00+00:00","description":"xv6 image: How exactly is the boot sector created and loaded?","headline":"xv6 image: How exactly is the boot sector created and loaded?","image":"https://yohei.codes/assets/images/dax86-xv6.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://yohei.codes/2020/06/13/xv6-boot-block.html"},"url":"https://yohei.codes/2020/06/13/xv6-boot-block.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://yohei.codes/feed.xml" title="yohei.codes" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52885755-2', 'auto');
  ga('send', 'pageview');
}
</script>
  
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon/favicon-16x16.png">
    <link rel="manifest" href="/assets/images/favicon/manifest.json">
    <link rel="mask-icon" href="/assets/images/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
  </head><body><header class="site-header" role="banner">

    <div class="wrapper"><a class="site-title" rel="author" href="/">yohei.codes</a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
  
          <div class="trigger"><a class="page-link" href="/about/">About</a>
    
    [          
    
        English ]
    

    
    [          
    
        
            <a href="/jp/2020/06/13/xv6-boot-block.html">日本語</a> ]
        
    
</div>
        </nav></div>
  </header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <h1 id="xv6-image-how-exactly-is-the-boot-sector-created-and-loaded">xv6 image: How exactly is the boot sector created and loaded?</h1>

<p>One of the difficulties I faced in the development of an x86 simulator, dax86 was the end-to-end understanding of the OS image structure. This article talks about the creation of the booting block and how it is formed into the OS image as well as how hardware loads and executes it.</p>

<h2 id="makefile">Makefile</h2>

<p>Makefile is where we start obviously. It has all the setup for creating different binaries and linked objects required to compose the OS image. As you can see below, <code class="language-plaintext highlighter-rouge">xv6.img</code> is requiring <code class="language-plaintext highlighter-rouge">bootblock</code> and <code class="language-plaintext highlighter-rouge">kernel</code> and executing <code class="language-plaintext highlighter-rouge">dd</code> command to write them. This part has some key information for locating different files, so I’ll come back to it in the later part of this article.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xv6.img: bootblock kernel
	<span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>xv6.img <span class="nv">count</span><span class="o">=</span>10000
	<span class="nb">dd </span><span class="k">if</span><span class="o">=</span>bootblock <span class="nv">of</span><span class="o">=</span>xv6.img <span class="nv">conv</span><span class="o">=</span>notrunc
	<span class="nb">dd </span><span class="k">if</span><span class="o">=</span>kernel <span class="nv">of</span><span class="o">=</span>xv6.img <span class="nv">seek</span><span class="o">=</span>1 <span class="nv">conv</span><span class="o">=</span>notrunc
</code></pre></div></div>

<h2 id="bootblock-creation">Bootblock Creation</h2>

<p>From the codes below, we can see <code class="language-plaintext highlighter-rouge">bootblock</code> is requiring <code class="language-plaintext highlighter-rouge">bootasm.S</code> which is a small asm mainly for entering into the protected mode and <code class="language-plaintext highlighter-rouge">bootmain.c</code> which copies kernel from disk to memory and jumps to it.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bootblock: bootasm.S bootmain.c
	<span class="si">$(</span>CC<span class="si">)</span> <span class="si">$(</span>CFLAGS<span class="si">)</span> <span class="nt">-fno-pic</span> <span class="nt">-O</span> <span class="nt">-nostdinc</span> <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-c</span> bootmain.c
	<span class="si">$(</span>CC<span class="si">)</span> <span class="si">$(</span>CFLAGS<span class="si">)</span> <span class="nt">-fno-pic</span> <span class="nt">-nostdinc</span> <span class="nt">-I</span><span class="nb">.</span> <span class="nt">-c</span> bootasm.S
	<span class="si">$(</span>LD<span class="si">)</span> <span class="si">$(</span>LDFLAGS<span class="si">)</span> <span class="nt">-N</span> <span class="nt">-e</span> start <span class="nt">-Ttext</span> 0x7C00 <span class="nt">-o</span> bootblock.o bootasm.o bootmain.o
	<span class="si">$(</span>OBJDUMP<span class="si">)</span> <span class="nt">-S</span> bootblock.o <span class="o">&gt;</span> bootblock.asm
	<span class="si">$(</span>OBJCOPY<span class="si">)</span> <span class="nt">-S</span> <span class="nt">-O</span> binary <span class="nt">-j</span> .text bootblock.o bootblock
	./sign.pl bootblock
</code></pre></div></div>

<p>Here I’d like to step back a bit and think of how a machine starts from the very beginning. Traditional computer with BIOS executes POST (power-on self test) once the power is on, followed by some configuration for MP from option ROM. After that it tries to find this signature of <code class="language-plaintext highlighter-rouge">0xAA55</code> at the last two bytes of the first sector of a bootdisk.</p>

<p>Below is the result of running <code class="language-plaintext highlighter-rouge">xxd</code> command on the OS image. We can observe the signature at the address <code class="language-plaintext highlighter-rouge">0x1FE</code> which is 2 bytes before the end of the sector (512 bytes),</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>xxd xv6.img
...
000001a0: 1518 0001 008d 65f4 5b5e 5f5d c300 0000  ......e.[^_]....
000001b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001f0: 0000 0000 0000 0000 0000 0000 0000 55aa  ..............U.
...
</code></pre></div></div>

<p>The last line of bootblock section of Makefile shown above: <code class="language-plaintext highlighter-rouge">./sign.pl bootblock</code> is actually creating this signature as below:</p>

<div class="language-perl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$buf</span> <span class="o">.=</span> <span class="p">"</span><span class="se">\</span><span class="s2">0</span><span class="p">"</span> <span class="nv">x</span> <span class="p">(</span><span class="mi">510</span><span class="o">-</span><span class="nv">$n</span><span class="p">);</span>
<span class="nv">$buf</span> <span class="o">.=</span> <span class="p">"</span><span class="se">\x55\xAA</span><span class="p">";</span>

<span class="nb">open</span><span class="p">(</span><span class="nv">SIG</span><span class="p">,</span> <span class="p">"</span><span class="s2">&gt;</span><span class="si">$ARGV</span><span class="s2">[0]</span><span class="p">")</span> <span class="o">||</span> <span class="nb">die</span> <span class="p">"</span><span class="s2">open &gt;</span><span class="si">$ARGV</span><span class="s2">[0]: $!</span><span class="p">";</span>
<span class="k">print</span> <span class="nv">SIG</span> <span class="nv">$buf</span><span class="p">;</span>
<span class="nb">close</span> <span class="nv">SIG</span><span class="p">;</span>
</code></pre></div></div>

<p>So we have traced until BIOS finds the bootable signature which is called master boot record (MBR). After this, BIOS copies this sector into memory typically at <code class="language-plaintext highlighter-rouge">0x7C00</code> and starts execution from there, which is the reason we see linker commands as <code class="language-plaintext highlighter-rouge">$(LD) $(LDFLAGS) -N -e start -Ttext 0x7C00 -o bootblock.o bootasm.o bootmain.o</code>. Here <code class="language-plaintext highlighter-rouge">text</code> secion is specified to be <code class="language-plaintext highlighter-rouge">0x7C00</code> so that the base address for instructions would match the addresses after BIOS loads the sector.</p>

<h2 id="bootloading">Bootloading</h2>

<p>Single sector of data loaded into memory is never enough to include the kernel codes of the OS. Its job is to load more data of the kernel instructions from disk, and it’s left to OS developer to make it work. In xv6, the kernel block is located and loaded from the second sector of the OS image. It took me some time to figure this out as tracing the whole flow involved IO communication with disk.</p>

<p>In the code below, we can see the <code class="language-plaintext highlighter-rouge">offset</code> is sector number with one added to the parameter:</p>

<p>bootmain.c</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>
<span class="nf">readseg</span><span class="p">(</span><span class="n">uchar</span><span class="o">*</span> <span class="n">pa</span><span class="p">,</span> <span class="n">uint</span> <span class="n">count</span><span class="p">,</span> <span class="n">uint</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">uchar</span><span class="o">*</span> <span class="n">epa</span><span class="p">;</span>

  <span class="n">epa</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">+</span> <span class="n">count</span><span class="p">;</span>

  <span class="c1">// Round down to sector boundary.</span>
  <span class="n">pa</span> <span class="o">-=</span> <span class="n">offset</span> <span class="o">%</span> <span class="n">SECTSIZE</span><span class="p">;</span>

  <span class="c1">// Translate from bytes to sectors; kernel starts at sector 1.</span>
  <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="n">SECTSIZE</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

  <span class="c1">// If this is too slow, we could read lots of sectors at a time.</span>
  <span class="c1">// We'd write more to memory than asked, but it doesn't matter --</span>
  <span class="c1">// we load in increasing order.</span>
  <span class="k">for</span><span class="p">(;</span> <span class="n">pa</span> <span class="o">&lt;</span> <span class="n">epa</span><span class="p">;</span> <span class="n">pa</span> <span class="o">+=</span> <span class="n">SECTSIZE</span><span class="p">,</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span>
    <span class="n">readsect</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>On the OS image creation, it’s specified as below:</p>

<p>Makefile</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">dd </span><span class="k">if</span><span class="o">=</span>kernel <span class="nv">of</span><span class="o">=</span>xv6.img <span class="nv">seek</span><span class="o">=</span>1 <span class="nv">conv</span><span class="o">=</span>notrun
</code></pre></div></div>

<p>Here, <code class="language-plaintext highlighter-rouge">seek=1</code> is the key. <code class="language-plaintext highlighter-rouge">seek=n</code> is the option of <code class="language-plaintext highlighter-rouge">dd</code> command to speficy the number of blocks to be skipped. As the default block size of <code class="language-plaintext highlighter-rouge">dd</code> is 512 bytes which is a sector, we can say <code class="language-plaintext highlighter-rouge">seek=1</code> is for skipping a sector which is for the boot block. Subsequently as showen in the <code class="language-plaintext highlighter-rouge">bootmain.c</code> code above, xv6 skips the first sector when it loads the kernel codes into its memory.</p>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">yohei.codes</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">yohei.codes</li><li><a class="u-email" href="mailto:me@yohei.codes">me@yohei.codes</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ykskb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ykskb</span></a></li><li><a href="https://www.linkedin.com/in/yohei-kusakabe"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">yohei-kusakabe</span></a></li><li><a href="https://www.twitter.com/yo__ohei"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">yo__ohei</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>I enjoy computer science stuff.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
