<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>DB Isolation Levels: Snapshot vs Serializable | yohei.codes</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="DB Isolation Levels: Snapshot vs Serializable" />
<meta property="og:locale" content="en" />
<meta name="description" content="Database Isolation Levels: Snapshot vs Serializable" />
<meta property="og:description" content="Database Isolation Levels: Snapshot vs Serializable" />
<link rel="canonical" href="https://yohei.codes/2023/09/07/snapshot-vs-serializable.html" />
<meta property="og:url" content="https://yohei.codes/2023/09/07/snapshot-vs-serializable.html" />
<meta property="og:site_name" content="yohei.codes" />
<meta property="og:image" content="https://yohei.codes/assets/images/screenshot.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-09-07T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://yohei.codes/assets/images/screenshot.png" />
<meta property="twitter:title" content="DB Isolation Levels: Snapshot vs Serializable" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-09-07T00:00:00+00:00","datePublished":"2023-09-07T00:00:00+00:00","description":"Database Isolation Levels: Snapshot vs Serializable","headline":"DB Isolation Levels: Snapshot vs Serializable","image":"https://yohei.codes/assets/images/screenshot.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://yohei.codes/2023/09/07/snapshot-vs-serializable.html"},"url":"https://yohei.codes/2023/09/07/snapshot-vs-serializable.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://yohei.codes/feed.xml" title="yohei.codes" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52885755-2', 'auto');
  ga('send', 'pageview');
}
</script>
  
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon/favicon-16x16.png">
    <link rel="manifest" href="/assets/images/favicon/manifest.json">
    <link rel="mask-icon" href="/assets/images/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
  </head><body><header class="site-header" role="banner">

    <div class="wrapper"><a class="site-title" rel="author" href="/">yohei.codes</a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
  
          <div class="trigger"><a class="page-link" href="/about/">About</a>
    
    [          
    
        English ]
    

    
    [          
    
        
            <a href="/jp/2023/09/07/snapshot-vs-serializable.html">日本語</a> ]
        
    
</div>
        </nav></div>
  </header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <h1 id="database-isolation-levels-snapshot-vs-serializable">Database Isolation Levels: Snapshot vs Serializable</h1>

<p>This page is an article based on notes I took while researching database isolation levels. Here, I focus on the differences between the snapshot isolation level and the serializable isolation level.</p>

<h2 id="write-skew-anomaly">Write Skew Anomaly</h2>

<p>A common scenario to compare snapshot isolation level and serializable isolation level is the write skew anomaly. In the snapshot isolation level model, this scenario is fundamentally not handled. This is because the conflict detection in snapshot isolation only targets changes to the same record and does not account for the order of the commit sequence, which is a design choice made for performance reasons. Below is the scenario:</p>

<ul>
  <li>
    <p>Transaction to update on-call doctors</p>

    <ul>
      <li>
        <p>The system needs to ensure that there is at least one doctor on call at all times.</p>
      </li>
      <li>
        <p>T1 (Transaction 1) wants to cancel Doctor A’s on-call duty if there is another doctor on call.</p>
      </li>
      <li>
        <p>T2 wants to cancel Doctor B’s on-call duty if there is another doctor on call.</p>
      </li>
      <li>
        <p>T1 and T2 occur at overlapping times in the timeline.</p>
      </li>
    </ul>

    <p>Transaction sequence:</p>

    <ol>
      <li>
        <p>T1 reads from the DB snapshot that both Doctor A and Doctor B are on call.</p>
      </li>
      <li>
        <p>T2 reads from the DB snapshot that both Doctor A and Doctor B are on call.</p>
      </li>
      <li>
        <p>T1 performs the update to cancel Doctor A’s on-call duty (successful).</p>
      </li>
      <li>
        <p>T2 performs the update to cancel Doctor B’s on-call duty (successful).</p>
      </li>
      <li>
        <p>As a result, the system fails to ensure that at least one doctor is on call, violating the requirement.</p>
      </li>
    </ol>
  </li>
</ul>

<p>In a serializable isolation level, to ensure the sequential integrity of transactions, only one of T1 or T2 (whichever started first) will succeed, and the other transaction will either roll back and retry, be blocked until the first transaction finishes and then retry, or fail. This example involves a type of conflict known as a read-write conflict.</p>

<p>Of course, implementing a lock is one way for developers to resolve this issue. For example, <code class="language-plaintext highlighter-rouge">SELECT FOR UPDATE</code> locks the data read by the ongoing transaction so that it cannot be read by other transactions until the transaction is complete. In the example above, once T1 reads the on-call data for Doctors A and B, T2 would not be able to read that data until T1 completes. This ensures that when T2 completes its read, T1 has already committed, allowing T2 to see that Doctor A’s on-call duty has been canceled and to make an informed decision about whether to cancel Doctor B’s on-call duty. In major databases, the default isolation level is typically <code class="language-plaintext highlighter-rouge">READ COMMITTED</code> or <code class="language-plaintext highlighter-rouge">REPEATABLE READ</code>, so unless transactions are implemented with proper locking there’ll always be a possibility of write skew. Its practical impact follows the next section.</p>

<h2 id="practical-impact">Practical Impact</h2>

<p><a href="https://en.wikipedia.org/wiki/Snapshot_isolation#Definition">The example from Wikipedia</a> illustrates a scenario where bank transactions could potentially allow a customer to withdraw more than their balance by performing simultaneous withdrawal transactions across multiple accounts. The scenario assumes that a customer has multiple accounts and is allowed to overdraw individual accounts as long as the total balance is non-negative. While this may seem like a theoretical example, it is plausible when considering the real-world user experience during withdrawals. For instance, if an account holder initiates simultaneous transactions to withdraw <code class="language-plaintext highlighter-rouge">$200</code> from two accounts, each with a balance of <code class="language-plaintext highlighter-rouge">$100</code>, the snapshot isolation level database may allow both transactions to succeed, resulting in a total balance of <code class="language-plaintext highlighter-rouge">-$200</code>.</p>

<p>Though these examples might appear theoretical, real-world cases of such attacks have been reported. According to a paper by members of Stanford InfoLab, “<a href="http://www.bailis.org/papers/acidrain-sigmod2017.pdf">ACIDRain: Concurrency-Related Attacks on Database-Backed Web Applications</a>,” there have been reports of data corruption severe enough to bankrupt a Bitcoin exchange, excessive usage of gift cards on e-commerce sites, and the collapse of product inventory data.</p>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">yohei.codes</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">yohei.codes</li><li><a class="u-email" href="mailto:me@yohei.codes">me@yohei.codes</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ykskb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ykskb</span></a></li><li><a href="https://www.linkedin.com/in/yohei-kusakabe"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">yohei-kusakabe</span></a></li><li><a href="https://www.twitter.com/yo__ohei"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">yo__ohei</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>I enjoy computer science stuff.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
