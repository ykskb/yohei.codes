<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Paper: MonetDB/X100: Hyper-Pipelining Query Execution | yohei.codes</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Paper: MonetDB/X100: Hyper-Pipelining Query Execution" />
<meta property="og:locale" content="en" />
<meta name="description" content="Paper: MonetDB/X100: Hyper-Pipelining Query Execution" />
<meta property="og:description" content="Paper: MonetDB/X100: Hyper-Pipelining Query Execution" />
<link rel="canonical" href="https://yohei.codes/2024/08/16/paper-monet-db-x-100.html" />
<meta property="og:url" content="https://yohei.codes/2024/08/16/paper-monet-db-x-100.html" />
<meta property="og:site_name" content="yohei.codes" />
<meta property="og:image" content="https://yohei.codes/assets/images/screenshot.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-08-16T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://yohei.codes/assets/images/screenshot.png" />
<meta property="twitter:title" content="Paper: MonetDB/X100: Hyper-Pipelining Query Execution" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-08-16T00:00:00+00:00","datePublished":"2024-08-16T00:00:00+00:00","description":"Paper: MonetDB/X100: Hyper-Pipelining Query Execution","headline":"Paper: MonetDB/X100: Hyper-Pipelining Query Execution","image":"https://yohei.codes/assets/images/screenshot.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://yohei.codes/2024/08/16/paper-monet-db-x-100.html"},"url":"https://yohei.codes/2024/08/16/paper-monet-db-x-100.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://yohei.codes/feed.xml" title="yohei.codes" /><script>
if(!(window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1")) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52885755-2', 'auto');
  ga('send', 'pageview');
}
</script>
  
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon/favicon-16x16.png">
    <link rel="manifest" href="/assets/images/favicon/manifest.json">
    <link rel="mask-icon" href="/assets/images/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
  </head><body><header class="site-header" role="banner">

    <div class="wrapper"><a class="site-title" rel="author" href="/">yohei.codes</a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
  
          <div class="trigger"><a class="page-link" href="/about/">About</a>
    
    [          
    
        English ]
    

    
    [          
    
        
            <a href="/jp/2024/08/16/paper-monet-db-x-100.html">日本語</a> ]
        
    
</div>
        </nav></div>
  </header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <h1 id="paper-monetdbx100-hyper-pipelining-query-execution">Paper: MonetDB/X100: Hyper-Pipelining Query Execution</h1>

<p>This articles is notes taken from the paper: <a href="http://cidrdb.org/cidr2005/papers/P19.pdf">MonetDB/X100: Hyper-Pipelining Query Execution</a>. It was published in 2005 at <a href="https://www.cidrdb.org/">The Conference on Innovative Data Systems Research (CIDR)</a> Conference.</p>

<blockquote>
  <h3 id="series-papers-adopted-by-duckdb">Series: Papers adopted by DuckDB</h3>

  <p>DuckDB can handle analytical query workloads incredibly fast. This series is my notes from the publications adopted by DuckDB (listed <a href="https://duckdb.org/why_duckdb.html#standing-on-the-shoulders-of-giants">here</a>).</p>

  <ul>
    <li>Vectorized Query Engine : this article</li>
    <li><a href="/2024/08/20/paper-fast-serializable-mvcc.html">Fast Serializable MVCC</a></li>
    <li>Join Ordering Optimization (coming soon)</li>
    <li>Unnesting Subqueries (coming soon)</li>
  </ul>

  <p>Note: though the concept of vectorized query execution model is adopted by DuckDB, the storage model explained in this paper is not the same as DuckDB’s one. Each column data is stored separatly in MonetDB whereas DuckDB storage uses row groups as mentioned <a href="https://duckdb.org/docs/internals/storage.html#row-groups">here</a>.</p>
</blockquote>

<h2 id="what-is-it-about">What is it about?</h2>

<p>This paper proposes a vectorized query execution model in DBMS for better utilization of modern CPUs, comparing it against traditional volcano iterator model.</p>

<ul>
  <li>
    <p>Performance comparision is through TPC-H benchmark: 22 complex SQL queries including large scans, joins, aggregations and nested queries.</p>
  </li>
  <li>
    <p>The paper doesn’t directly mention, but MonetDB is a columnar DB and the comparisons suggest that the mentioned traditional volcano model is assumed to be row-oriented DB.</p>
  </li>
</ul>

<h2 id="interpretation-of-query">Interpretation of query</h2>

<ul>
  <li>
    <p>Traditional: volcano iterator model = tuple by tuple</p>

    <p>Each tuple must repeated go through various operators like filters, joins and aggregations -&gt; high interpretation overhead &amp; limited opportunities for CPU parallelism.</p>
  </li>
  <li>
    <p>Proposed: vectorized processing</p>

    <p>Applies filter, join and aggregation operations to entire data vectors at once.</p>
  </li>
</ul>

<h2 id="cpu-cache-utilization">CPU cache utilization</h2>

<ul>
  <li>
    <p>Traditional: entire tuple needs to be loaded into memory, so unused data uses cacheline as well when data is accessed, leading to more frequent cache misses.</p>
  </li>
  <li>
    <p>Proposed: only relevant data is loaded into memory</p>

    <ul>
      <li>
        <p>Spacial locality: data of a single column is stored contiguously in memory -&gt; better cache hits &amp; contiguous memory accesses</p>
      </li>
      <li>
        <p>Temporal locality: once data is loaded into cache, it is used repeatedly before the next chunk is loaded.</p>
      </li>
    </ul>
  </li>
</ul>

<p>Example:</p>
<ul>
  <li>
    <p>Table: <code class="language-plaintext highlighter-rouge">sale_id INT, date DATE, product_id INT, quantity INT, price FLOAT</code></p>
  </li>
  <li>
    <p>Query: <code class="language-plaintext highlighter-rouge">SELECT SUM (quantity * price) AS total_revenue FROM sales;</code></p>
  </li>
  <li>
    <p>Cacheline:</p>

    <ul>
      <li>
        <p>Row-oriented: unused columns on cacheline</p>

        <p><code class="language-plaintext highlighter-rouge">[ sale_id | date | product_id | quantity | price | sale_id... ]</code></p>
      </li>
      <li>
        <p>Columnar data: only used data is cached</p>

        <p><code class="language-plaintext highlighter-rouge">[ quantity | quantity | quantity | quantity... ]</code></p>
      </li>
    </ul>
  </li>
</ul>

<h2 id="cpu-pipeline-execution">CPU Pipeline Execution</h2>

<ul>
  <li>
    <p>Traditional: tuple-by-tuple &amp; row-oriented</p>

    <ul>
      <li>
        <p>CPU stalls while data is loaded due to frequent cache misses as mentioned above.</p>
      </li>
      <li>
        <p>Instructions need to be repeatedly fetched per tuple (No SIMD).</p>
      </li>
      <li>
        <p>Conditions such as <code class="language-plaintext highlighter-rouge">IF</code> or <code class="language-plaintext highlighter-rouge">WHERE</code> per tuple lead to branch mispredictions.</p>
      </li>
      <li>
        <p>Data / control hazards = operation dependencies. Operations need to wait for previous operations to finish before proceeding.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Proposed: vectorized processing</p>

    <ul>
      <li>
        <p>Less cache misses = less CPU stalls.</p>
      </li>
      <li>
        <p>Vectorized data align well with <a href="https://en.wikipedia.org/wiki/Single_instruction,_multiple_data">SIMD</a> can significantly optimize data processing.</p>
      </li>
      <li>
        <p>Less or no dependency between operations, so CPU pipelines can plan and execute operations effectively.</p>
      </li>
    </ul>
  </li>
</ul>

<h2 id="benchmarks">Benchmarks</h2>

<ul>
  <li>
    <p>TPC-H Query 1: scan, arithmetic and aggregation operations on a large table. CPU-bound workload without complex operations such as <code class="language-plaintext highlighter-rouge">JOIN</code>.</p>

    <ul>
      <li>
        <p>MySQL</p>

        <ul>
          <li>
            <p>Execution time: <code class="language-plaintext highlighter-rouge">100 secs</code> which is significantly higher due to inefficiency of tuple-by-tuple processing.</p>
          </li>
          <li>
            <p>Breakdown: 10% for computation, 28% for hash table management for aggregation and 62% copying and navigating through records.</p>
          </li>
          <li>
            <p>Instructions per Cycle (IPC): around 0.8 which is low.</p>
          </li>
        </ul>
      </li>
      <li>
        <p>X100</p>

        <ul>
          <li>
            <p>Execution time: <code class="language-plaintext highlighter-rouge">20 secs</code> which is significantly lower.</p>
          </li>
          <li>
            <p>Breakdown: computation much larger fraction for computation itself. Operations for hash table and record navigation were minimized.</p>
          </li>
          <li>
            <p>IPC: around 2.0 which is higher compared to MySQL.</p>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="notes-on-monet-db">Notes on Monet DB</h2>

<ul>
  <li>
    <p>Vertical Fragmentation: each column is store as a Binary Association Table (BAT), containing <code class="language-plaintext highlighter-rouge">[object_id, value]</code></p>

    <ul>
      <li>
        <p>Deletes: Marked by adding tuple IDs to a deletion list.</p>
      </li>
      <li>
        <p>Inserts: Handled by appending to separate delta columns.</p>
      </li>
      <li>
        <p>Updates: Implemented as a combination of a delete and an insert.</p>
      </li>
      <li>
        <p>Reorganization: when delta columns exceeds a small percentage of total table size, the delta is merged with the main storage.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Arrays of column data are passed as <code class="language-plaintext highlighter-rouge">restrict</code> pointers so C compiler would generate loop-pipelining, which is optimized processing of array data.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">GROUP BY</code> is optimized with bit-representations used directly as indices in an array of aggregation results.</p>
  </li>
</ul>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">yohei.codes</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">yohei.codes</li><li><a class="u-email" href="mailto:me@yohei.codes">me@yohei.codes</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/ykskb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">ykskb</span></a></li><li><a href="https://www.linkedin.com/in/yohei-kusakabe"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">yohei-kusakabe</span></a></li><li><a href="https://www.twitter.com/yo__ohei"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">yo__ohei</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>I enjoy computer science stuff.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
